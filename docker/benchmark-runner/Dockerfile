# Copyright 2020 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
# Dockerfile for running a specific benchmark for a specific fuzzer.
#
# This Dockerfile adds essential files into the runner image, regardless of
# whether it was built from `benchmark-runner/Dockerfile` or a custom
# `runner.Dockerfile`.
#
# The benchmark/fuzzer pair is defined by build arguments. To specify them, pass
# the following arguments to docker build:
#
# $ docker build \
#   --build-arg benchmark=afl \
#   --build-arg fuzzer=freetype2-2017 \
#   ...

ARG fuzzer
ARG benchmark

# -----------------------------
# Proxy (build-time configurable)
# -----------------------------
ARG HTTP_PROXY=http://172.17.0.1:7890
ARG HTTPS_PROXY=http://172.17.0.1:7890
ARG NO_PROXY=localhost,127.0.0.1,::1,172.17.0.0/16

# We use Docker's multi-stage build feature to create a minimal runner image,
# separate from the sometimes bulky builder images.

# We take the already built builder image for the given fuzzer/benchmark pair
# and refer to it as "builder", so we can copy the build artifacts from it.
FROM gcr.io/fuzzbench/builders/$fuzzer/$benchmark AS builder

# We base the runner image from the intermediate runner image, defined by the
# runner.Dockerfile of each fuzzer.
FROM gcr.io/fuzzbench/runners/$fuzzer/$benchmark-intermediate

ENV HTTP_PROXY=${HTTP_PROXY} \
    HTTPS_PROXY=${HTTPS_PROXY} \
    NO_PROXY=${NO_PROXY} \
    http_proxy=${HTTP_PROXY} \
    https_proxy=${HTTPS_PROXY} \
    no_proxy=${NO_PROXY}

# -----------------------------
# APT robustness (retries/timeouts)
# -----------------------------
RUN set -eux; \
    printf '%s\n' \
      'Acquire::Retries "8";' \
      'Acquire::http::Timeout "60";' \
      'Acquire::https::Timeout "60";' \
      'Acquire::http::Pipeline-Depth "0";' \
      'Acquire::https::Pipeline-Depth "0";' \
      > /etc/apt/apt.conf.d/80-fuzzbench-retries

# Install runtime dependencies for benchmarks (retry loop for proxy flakiness).
RUN set -eux; \
    for i in 1 2 3 4 5 6 7 8; do \
      apt-get update -y && \
      DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
        libglib2.0-0 \
        libxml2 \
        libarchive13 \
        libgss3 \
      && break; \
      echo "apt-get failed ($i/8), retrying..."; \
      sleep 10; \
      apt-get update --fix-missing || true; \
    done; \
    rm -rf /var/lib/apt/lists/*

# Set up the directory for the build artifacts.
ENV OUT=/out
ENV WORKDIR=/out

RUN mkdir -p "$WORKDIR"
WORKDIR "$WORKDIR"

ENV ROOT_DIR=/src

# Copy over all the build artifacts (without * to preserve directory structure).
# This also copies seed and dictionary files if they are available.
COPY --from=builder /out/ ./

# Copy the benchmarks directory.
COPY benchmarks $ROOT_DIR/benchmarks
# Copy the fuzzers directory.
COPY fuzzers $ROOT_DIR/fuzzers

# Define environment variables used when we run the fuzzer:
# - Directory to get starting seeds from.
ENV SEED_CORPUS_DIR=$WORKDIR/seeds
# - Where to place new test cases generated by the fuzzer.
ENV OUTPUT_CORPUS_DIR=$WORKDIR/corpus

# Create the seeds directory if it doesn't exist.
RUN mkdir -p "$SEED_CORPUS_DIR" "$OUTPUT_CORPUS_DIR"

# Copy the source code into the image. We do this here instead of in base-image
# because it is likely to change, particularly in development. If this were done
# earlier, build cycles would be intolerably slow.
COPY common $ROOT_DIR/common
COPY experiment/runner.py $ROOT_DIR/experiment/runner.py
COPY docker/benchmark-runner $ROOT_DIR/docker/benchmark-runner

ENV PYTHONPATH=$ROOT_DIR
RUN chmod +x $ROOT_DIR/docker/benchmark-runner/startup-runner.sh
ENTRYPOINT $ROOT_DIR/docker/benchmark-runner/startup-runner.sh